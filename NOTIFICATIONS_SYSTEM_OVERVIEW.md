# 📢 סקירת מערכת ההתראות - SkillUp

## סיכום כללי

מערכת ההתראות במערכת SkillUp מבוססת על **Database Trigger** (migration 048) שמזהה שינויים בטבלת `bookings` ויוצר התראות אוטומטית.

---

## 🎯 סוגי התראות

### 1. **BOOKING_CONFIRMED** ✅
התראה על שיעור שנקבע או אושר

### 2. **BOOKING_CANCELLED** 🚫
התראה על שיעור שבוטל

### 3. **BOOKING_RESCHEDULED** 📅
התראה על שיעור שנדחה/שונה

### 4. **NEW_MESSAGE** 💬
התראה על הודעה חדשה (לא קשור ל-bookings)

---

## 📋 התראות לפי אירוע

### 🆕 **יצירת שיעור חדש (INSERT)**

**מתי:** כאשר תלמיד יוצר שיעור חדש

| משתמש | התראה? | סוג | כותרת | תת-כותרת |
|--------|---------|-----|--------|-----------|
| **מורה** | ✅ כן | `BOOKING_CONFIRMED` | `שיעור חדש נקבע! 📚` | `[שם תלמיד] קבע איתך שיעור ב[מקצוע] ל-[תאריך ושעה]` |
| **תלמיד** | ❌ לא | - | - | - |

**הסבר:** התלמיד לא מקבל התראה כי הוא רואה הודעת הצלחה במסך.

---

### ✅ **אישור שיעור (UPDATE: pending → confirmed)**

**מתי:** כאשר מורה מאשר שיעור שהיה במצב `pending`

| משתמש | התראה? | סוג | כותרת | תת-כותרת |
|--------|---------|-----|--------|-----------|
| **מורה** | ✅ כן | `BOOKING_CONFIRMED` | `אישרת את השיעור ✅` | `שיעור ב[מקצוע] עם [שם תלמיד] ב-[תאריך ושעה]` |
| **תלמיד** | ✅ כן | `BOOKING_CONFIRMED` | `המורה אישר את השיעור! 🎉` | `[שם מורה] אישר את השיעור ב[מקצוע] ב-[תאריך ושעה]` |

---

### 🚫 **ביטול שיעור (UPDATE: status → cancelled)**

#### א. **מורה מבטל:**

| משתמש | התראה? | סוג | כותרת | תת-כותרת |
|--------|---------|-----|--------|-----------|
| **מורה** | ✅ כן | `BOOKING_CANCELLED` | `ביטלת את השיעור 🚫` | `שיעור ב[מקצוע] עם [שם תלמיד] שהיה אמור להיות ב-[תאריך ושעה]` |
| **תלמיד** | ✅ כן | `BOOKING_CANCELLED` | `המורה ביטל את השיעור 🚫` | `[שם מורה] ביטל את השיעור ב[מקצוע] שהיה אמור להיות ב-[תאריך ושעה]` |

#### ב. **תלמיד מבטל:**

| משתמש | התראה? | סוג | כותרת | תת-כותרת |
|--------|---------|-----|--------|-----------|
| **מורה** | ✅ כן | `BOOKING_CANCELLED` | `התלמיד ביטל את השיעור 🚫` | `[שם תלמיד] ביטל את השיעור ב[מקצוע] שהיה אמור להיות ב-[תאריך ושעה]` |
| **תלמיד** | ✅ כן | `BOOKING_CANCELLED` | `ביטלת את השיעור 🚫` | `שיעור ב[מקצוע] עם [שם מורה] שהיה אמור להיות ב-[תאריך ושעה]` |

#### ג. **מערכת/מנהל מבטל:**

| משתמש | התראה? | סוג | כותרת | תת-כותרת |
|--------|---------|-----|--------|-----------|
| **מורה** | ✅ כן | `BOOKING_CANCELLED` | `השיעור בוטל 🚫` | `שיעור ב[מקצוע] עם [שם תלמיד] שהיה אמור להיות ב-[תאריך ושעה]` |
| **תלמיד** | ✅ כן | `BOOKING_CANCELLED` | `השיעור בוטל 🚫` | `שיעור ב[מקצוע] עם [שם מורה] שהיה אמור להיות ב-[תאריך ושעה]` |

---

### 📅 **דחייה/שינוי מועד (UPDATE: start_at שונה)**

#### א. **מורה דוחה:**

| משתמש | התראה? | סוג | כותרת | תת-כותרת |
|--------|---------|-----|--------|-----------|
| **מורה** | ✅ כן | `BOOKING_RESCHEDULED` | `דחית את השיעור 📅` | `שיעור ב[מקצוע] עם [שם תלמיד] נדחה ל-[תאריך ושעה חדש]` |
| **תלמיד** | ✅ כן | `BOOKING_RESCHEDULED` | `המורה דחה את השיעור 📅` | `[שם מורה] דחה את השיעור ב[מקצוע] ל-[תאריך ושעה חדש]` |

#### ב. **תלמיד דוחה:**

| משתמש | התראה? | סוג | כותרת | תת-כותרת |
|--------|---------|-----|--------|-----------|
| **מורה** | ✅ כן | `BOOKING_RESCHEDULED` | `התלמיד דחה את השיעור 📅` | `[שם תלמיד] דחה את השיעור ב[מקצוע] ל-[תאריך ושעה חדש]` |
| **תלמיד** | ✅ כן | `BOOKING_RESCHEDULED` | `דחית את השיעור 📅` | `שיעור ב[מקצוע] עם [שם מורה] נדחה ל-[תאריך ושעה חדש]` |

#### ג. **מערכת/מנהל דוחה:**

| משתמש | התראה? | סוג | כותרת | תת-כותרת |
|--------|---------|-----|--------|-----------|
| **מורה** | ✅ כן | `BOOKING_RESCHEDULED` | `השיעור נדחה 📅` | `שיעור ב[מקצוע] עם [שם תלמיד] נדחה ל-[תאריך ושעה חדש]` |
| **תלמיד** | ✅ כן | `BOOKING_RESCHEDULED` | `השיעור נדחה 📅` | `שיעור ב[מקצוע] עם [שם מורה] נדחה ל-[תאריך ושעה חדש]` |

---

## 🔧 איך זה עובד?

### Database Trigger
כל ההתראות נוצרות על ידי **Trigger** (`notify_both_parties_on_booking_changes`) שפועל על טבלת `bookings`:

- **Trigger Event:** `AFTER INSERT OR UPDATE`
- **Function:** `notify_both_parties_on_booking_changes()`
- **Location:** Migration 048

### RPC Function
ה-RPC function `create_booking` **לא יוצר התראות** (הוסר ב-migration 047) כדי למנוע כפילויות.

---

## 📊 טבלת סיכום

| אירוע | מורה מקבל? | תלמיד מקבל? | הערות |
|-------|-------------|-------------|-------|
| **יצירת שיעור חדש** | ✅ כן | ❌ לא | תלמיד רואה הודעת הצלחה במסך |
| **אישור שיעור** | ✅ כן | ✅ כן | מורה מאשר שיעור pending |
| **ביטול (מורה)** | ✅ כן | ✅ כן | - |
| **ביטול (תלמיד)** | ✅ כן | ✅ כן | - |
| **ביטול (מערכת)** | ✅ כן | ✅ כן | - |
| **דחייה (מורה)** | ✅ כן | ✅ כן | - |
| **דחייה (תלמיד)** | ✅ כן | ✅ כן | - |
| **דחייה (מערכת)** | ✅ כן | ✅ כן | - |

---

## 🎨 הצגת התראות

### Toast Notifications
התראות מוצגות כ-**Toast** באמצעות `NotificationToast` component:

- **BOOKING_CONFIRMED:** ✅ ירוק (CheckCircle)
- **BOOKING_CANCELLED:** 🚫 אדום (XCircle)
- **BOOKING_RESCHEDULED:** 📅 צהוב (Clock)
- **NEW_MESSAGE:** 💬 כחול (MessageCircle)

### Navigation
לחיצה על התראה מנווטת ל:
- **BOOKING_*** → `/(tabs)/lessons`
- **NEW_MESSAGE** → `/(tabs)/messages/[conversation_id]`

---

## ⚠️ הערות חשובות

1. **אין התראות כפולות:** ה-RPC function לא יוצר התראות (הוסר ב-migration 047)
2. **תלמיד לא מקבל התראה בעת יצירה:** רואה הודעת הצלחה במסך
3. **כל ההתראות נוצרות ב-Database:** אין התראות בקוד הקליינט
4. **התראות מותאמות אישית:** התוכן משתנה לפי מי ביצע את הפעולה

---

## 📝 Migrations רלוונטיים

- **Migration 046:** הוספת התראות לתלמידים
- **Migration 047:** הסרת התראות כפולות מה-RPC function
- **Migration 048:** הסרת התראה לתלמיד בעת יצירת שיעור חדש

---

**עודכן אחרון:** לאחר migration 048

