# מימוש קופונים - תיעוד פיצ'ר

## סקירה כללית

נוספה אפשרות מלאה למימוש קופונים באפליקציה. תלמידים יכולים כעת להזין קוד קופון ולקבל קרדיטים לחשבון שלהם.

**שני מקומות למימוש קופונים:**

1. **מסך מימוש קופון עצמאי** (`(profile)/redeem-coupon`)
   - גישה: פרופיל → "מימוש קופון"
   - שימוש: מימוש קופון והוספת קרדיטים לחשבון לשימוש עתידי
   - מתאים: כשיש לך קוד קופון ואתה רוצה "לטעון" קרדיטים

2. **שלב 5 בזרימת ההזמנה** (`BookingStep5`)
   - גישה: תהליך הזמנת שיעור → שלב "תשלום"
   - שימוש: מימוש קופון ישירות בתהליך ההזמנה
   - מתאים: כשאתה מזמין שיעור ורוצה להשתמש בקוד קופון מיד
   - יתרון: הקרדיטים מתווספים ומחולים אוטומטית על ההזמנה הנוכחית

## מה נוסף

### 1. מסך חדש - מימוש קופון
**קובץ**: `app/(profile)/redeem-coupon.tsx`

**פיצ'רים:**
- ✅ ממשק משתמש מודרני ונקי
- ✅ שדה קלט עם המרה אוטומטית לאותיות גדולות
- ✅ כפתור מימוש עם אינדיקטור טעינה
- ✅ הודעות הצלחה/שגיאה ברורות
- ✅ רשימת קופונים זמינים לדוגמה
- ✅ תמיכה מלאה ב-RTL (עברית)
- ✅ אינטגרציה עם CreditsContext לרענון יתרה

**זרימה:**
1. משתמש מזין קוד קופון
2. לוחץ על "מימוש קופון"
3. המערכת שולחת בקשה ל-API
4. במקרה של הצלחה:
   - מציגה הודעת הצלחה
   - מרעננת את יתרת הקרדיטים
   - מציגה Alert עם פרטי הקופון
   - מאפשרת חזרה למסך הקודם
5. במקרה של שגיאה:
   - מציגה הודעת שגיאה ברורה בהתאם לסוג השגיאה

### 2. הוספה לתפריט הפרופיל
**קובץ**: `app/(tabs)/profile.tsx`

**שינויים:**
- ✅ ייבוא אייקון `Ticket` מ-lucide-react-native
- ✅ פריט תפריט חדש "מימוש קופון" במיקום השני (אחרי "ערוך פרופיל")
- ✅ ניווט למסך מימוש הקופון

### 3. אינטגרציה בזרימת ההזמנה (Step 5)
**קובץ**: `src/components/booking/BookingStep5.tsx`

**פיצ'רים חדשים:**
- ✅ מימוש קופונים ישירות בתהליך ההזמנה
- ✅ שדה קלט עם המרה אוטומטית לאותיות גדולות
- ✅ כפתור "החל" מחובר ל-API עם אינדיקטור טעינה
- ✅ בדיקה אמיתית מול מסד הנתונים (לא mock)
- ✅ הודעות הצלחה/שגיאה דינאמיות מתחת לשדה
- ✅ חישוב אוטומטי של ההנחה בפירוט המחיר
- ✅ הקרדיטים מהקופון מתווספים לחשבון ומחולים אוטומטית על ההזמנה

**זרימה:**
1. משתמש מזין קוד קופון בשלב 5 של ההזמנה
2. לוחץ על "החל"
3. המערכת:
   - מממשת את הקופון (קריאה ל-`redeemCoupon`)
   - מוסיפה את הקרדיטים לחשבון המשתמש
   - מציגה הודעת הצלחה
   - מעדכנת את חישוב המחיר אוטומטית
4. המשתמש רואה את ההנחה בפירוט המחיר
5. הקרדיטים זמינים גם לשימוש עתידי

### 4. API קיים (נמצא כבר במערכת)
**קובץ**: `src/services/api/creditsAPI.ts`

**פונקציה**: `redeemCoupon(code: string)`
- מקבלת קוד קופון
- שולחת בקשה ל-RPC `redeem_coupon` ב-Supabase
- מחזירה תוצאה: הצלחה/כישלון, כמות קרדיטים, תיאור

## קופונים זמינים

### 1. WELCOME100
- **קרדיטים**: 100 ₪
- **שימושים**: עד 10 פעמים (סה"כ במערכת)
- **תיאור**: קופון ברוכים הבאים
- **מקור**: Migration 024

### 2. MAXCREDITS2025
- **קרדיטים**: 99,999 ₪
- **שימושים**: ללא הגבלה
- **תיאור**: קופון מיוחד - מקסימום קרדיטים
- **מקור**: Migration 024

## טיפול בשגיאות

המסך מטפל בסוגי השגיאות הבאים:

| קוד שגיאה | הודעה למשתמש |
|-----------|--------------|
| Empty input | "אנא הזן קוד קופון" |
| Already redeemed | "כבר מימשת את הקופון הזה בעבר" |
| Not found | "קוד קופון לא תקף" |
| Expired | "הקופון פג תוקף" |
| Max uses reached | "הקופון הגיע למקסימום השימושים" |
| Generic error | "שגיאה במימוש הקופון" |

## דרישות Migration

כדי שהפיצ'ר יעבוד, יש להריץ את ה-migrations הבאים ב-Supabase:

1. **Migration 024** - `migrations/024_create_coupons_system.sql`
   - יוצר טבלאות: `coupons`, `coupon_redemptions`
   - יוצר פונקציה: `redeem_coupon`
   - יוצר RLS policies
   - מוסיף קופונים: WELCOME100, MAXCREDITS2025

## בדיקות

### בדיקה ידנית - מסך מימוש קופון:
1. ✅ כנס לאפליקציה כתלמיד
2. ✅ עבור לפרופיל → "מימוש קופון"
3. ✅ הזן קוד `MAXCREDITS2025`
4. ✅ לחץ על "מימוש קופון"
5. ✅ וודא שהיתרה עודכנה ל-99,999 ₪
6. ✅ נסה למשש שוב את אותו קופון → צריך להציג שגיאה "כבר מימשת"

### בדיקה ידנית - זרימת הזמנה:
1. ✅ כנס לאפליקציה כתלמיד
2. ✅ התחל תהליך הזמנת שיעור
3. ✅ הגע לשלב 5 (תשלום)
4. ✅ גלול למטה לשדה "קוד קופון"
5. ✅ הזן קוד `WELCOME100`
6. ✅ לחץ על כפתור "החל"
7. ✅ וודא שמופיעה הודעת הצלחה ירוקה
8. ✅ בדוק שבפירוט המחיר מופיעה שורת "הנחה (קופון)"
9. ✅ וודא שהמחיר הסופי עודכן
10. ✅ נסה להזין קוד לא תקף → צריכה להופיע הודעת שגיאה אדומה

### בדיקות נוספות:
- ✅ הזנת קוד לא תקף → הודעת שגיאה מתאימה (אדומה)
- ✅ שדה ריק + לחיצה → כפתור לא פעיל (אפור)
- ✅ קוד עם אותיות קטנות → המרה אוטומטית לגדולות
- ✅ ביטול הפעולה באמצע טעינה → spinner מוצג
- ✅ RTL - כל הטקסטים מיושרים נכון (ימין)
- ✅ שני מסכים עובדים באותה צורה (עקביות UI)

## SQL לבדיקה

```sql
-- בדוק אילו קופונים קיימים
SELECT * FROM coupons;

-- בדוק מי מימש קופונים
SELECT
  cr.*,
  p.display_name as student_name,
  c.code as coupon_code
FROM coupon_redemptions cr
JOIN profiles p ON p.id = cr.student_id
JOIN coupons c ON c.id = cr.coupon_id
ORDER BY cr.redeemed_at DESC;

-- בדוק יתרות קרדיטים
SELECT
  p.display_name,
  sc.balance
FROM student_credits sc
JOIN profiles p ON p.id = sc.student_id
ORDER BY sc.balance DESC;

-- אפס את מימושי הקופונים (לבדיקות חוזרות)
DELETE FROM coupon_redemptions WHERE student_id = 'YOUR_USER_ID';
```

## Screenshot Flow

1. **מסך פרופיל** → פריט "מימוש קופון" עם אייקון כרטיס 🎫
2. **מסך מימוש קופון** → כותרת + הסבר + שדה קלט
3. **אחרי מילוי קוד** → כפתור כחול פעיל
4. **בזמן שליחה** → spinner טעינה
5. **הצלחה** → הודעה ירוקה + Alert עם פרטים
6. **שגיאה** → הודעה אדומה עם הסבר

## קבצים שנוצרו/שונו

### נוצרו:
- ✅ `app/(profile)/redeem-coupon.tsx` (~300 שורות) - מסך מימוש קופונים עצמאי
- ✅ `COUPON_REDEMPTION_FEATURE.md` (מסמך זה)

### שונו:
- ✅ `app/(tabs)/profile.tsx` (+2 imports, +7 שורות בתפריט)
- ✅ `src/components/booking/BookingStep5.tsx` (+50 שורות) - **חיבור קופונים לזרימת ההזמנה**
  - ייבוא `redeemCoupon` מ-API
  - הוספת states: `isCheckingCoupon`, `couponError`, `appliedCouponCredits`, `appliedCouponDescription`
  - פונקציה `handleApplyCoupon()` - מימוש אמיתי של קופונים במקום mock
  - שדה קלט משופר עם המרה אוטומטית לאותיות גדולות
  - כפתור "החל" מחובר ל-API עם spinner טעינה
  - הודעות הצלחה/שגיאה דינאמיות
  - חישוב discount מבוסס על קרדיטים אמיתיים מהקופון

### קיימים (לא שונו):
- `src/services/api/creditsAPI.ts` - הפונקציה `redeemCoupon` כבר הייתה
- `migrations/024_create_coupons_system.sql` - המיגרציה כבר הייתה

## תמיכה טכנית

**אם הכפתור לא עובד:**
1. וודא ש-migration 024 רץ ב-Supabase
2. בדוק שהטבלה `coupons` קיימת ויש בה נתונים
3. בדוק שהפונקציה `redeem_coupon` קיימת
4. וודא שהמשתמש מחובר (יש session)
5. בדוק את ה-console logs לשגיאות

**אם הקרדיטים לא מתעדכנים:**
1. בדוק שהפונקציה `refetchCredits()` נקראת
2. וודא שהטבלה `student_credits` קיימת
3. בדוק ש-RLS policies מאפשרים גישה
4. רענן את האפליקציה (reload)

## המשך פיתוח

**אפשרויות להרחבה:**
- 📅 הוספת תאריכי תפוגה לקופונים
- 👥 קופונים אישיים לכל משתמש
- 📊 ממשק ניהול קופונים למנהלים
- 🔔 התראות על קופונים חדשים
- 🎁 קופונים מותנים (לדוגמה: רק לתלמידים חדשים)
- 📈 אנליטיקה על שימוש בקופונים

---

**תאריך יצירה**: 30 אוקטובר 2025
**גרסה**: 1.0
**סטטוס**: ✅ מוכן לשימוש
